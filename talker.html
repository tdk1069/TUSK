<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPC Talk-Tree Builder</title>
    <style>
        :root { --bg: #f4f4f9; --card: #ffffff; --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--primary); margin: 0; padding: 20px; display: flex; height: 100vh; box-sizing: border-box; }
        
        /* Layout */
        .container { display: flex; width: 100%; gap: 20px; height: 100%; }
        .editor { flex: 2; overflow-y: auto; padding-right: 10px; }
        .preview { flex: 1; display: flex; flex-direction: column; background: var(--card); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; }

        /* Cards */
        .state-card { background: var(--card); border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px; position: relative; border-left: 5px solid var(--accent); }
        .state-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
        
        /* Options */
        .option-row { 
            background: #f8f9fa; border: 1px solid #eee; padding: 8px; border-radius: 4px; margin-bottom: 8px; 
            display: grid; grid-template-columns: 25px 1fr 1fr 100px 40px; gap: 8px; align-items: center; 
        }
        
        /* Move Buttons Control */
        .move-controls { display: flex; flex-direction: column; gap: 2px; }
        .btn-move { 
            background: #e0e0e0; color: #333; font-size: 0.6em; padding: 2px 0; 
            height: 18px; line-height: 1; width: 100%; border-radius: 2px;
        }
        .btn-move:hover { background: #ccc; }
        .btn-move:disabled { opacity: 0.3; cursor: default; }

        .option-row label { font-size: 0.7em; color: #666; display: block; margin-bottom: 2px; }
        input, select { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9em; }
        
        /* Standard Buttons */
        button { cursor: pointer; border: none; padding: 8px 12px; border-radius: 4px; font-size: 0.9em; transition: 0.2s; }
        .btn-add-opt { background: #eef2f5; color: var(--primary); width: 100%; margin-top: 5px; border: 1px dashed #ccc; }
        .btn-add-opt:hover { background: #e0e6ed; }
        .btn-add-state { background: var(--accent); color: white; padding: 15px; font-size: 1.1em; width: 100%; margin-bottom: 50px; }
        .btn-del { background: var(--danger); color: white; padding: 5px 10px; }
        .btn-copy { background: var(--primary); color: white; margin-top: 10px; padding: 10px; }

        /* Code Block */
        textarea { flex-grow: 1; width: 100%; resize: none; font-family: 'Courier New', monospace; font-size: 0.85em; background: #282c34; color: #abb2bf; border-radius: 4px; padding: 10px; border: none; }
        h2 { margin-top: 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="editor" id="editor">
        <h2>Dialogue Editor</h2>
        <div id="states-container"></div>
        <button class="btn-add-state" onclick="addState()">+ Add New Page (State)</button>
    </div>

    <div class="preview">
        <h2>LPC Code Preview</h2>
        <textarea id="code-output" readonly></textarea>
        <button class="btn-copy" onclick="copyCode()">Copy to Clipboard</button>
    </div>
</div>

<script>
    // Data Model
    let states = [
        { 
            id: 0, 
            options: [
                { player: "Hello, who are you?", npc: "say I am an Ent.", target: 1 },
                { player: "Goodbye.", npc: "say Farewell.", target: -1 }
            ] 
        },
        { 
            id: 1, 
            options: [
                { player: "What is an Ent?", npc: "say We encompass the trees.", target: 0 },
                { player: "I must go.", npc: "say Bye.", target: -1 }
            ] 
        }
    ];

    const container = document.getElementById('states-container');
    const output = document.getElementById('code-output');

    function render() {
        container.innerHTML = '';
        
        states.forEach((state, index) => {
            const card = document.createElement('div');
            card.className = 'state-card';
            
            card.innerHTML = `
                <div class="state-header">
                    <span>PAGE ${index}</span>
                    ${index > 0 ? `<button class="btn-del" onclick="removeState(${index})">X</button>` : ''}
                </div>
                <div id="opts-${index}"></div>
                <button class="btn-add-opt" onclick="addOption(${index})">+ Add Option</button>
            `;

            container.appendChild(card);

            const optsContainer = document.getElementById(`opts-${index}`);
            
            state.options.forEach((opt, optIndex) => {
                const isFirst = optIndex === 0;
                const isLast = optIndex === state.options.length - 1;

                const row = document.createElement('div');
                row.className = 'option-row';

                row.innerHTML = `
                    <div class="move-controls">
                        <button class="btn-move" ${isFirst ? 'disabled' : ''} onclick="moveOption(${index}, ${optIndex}, -1)">▲</button>
                        <button class="btn-move" ${isLast ? 'disabled' : ''} onclick="moveOption(${index}, ${optIndex}, 1)">▼</button>
                    </div>
                    <div>
                        <label>Player Says</label>
                        <input type="text" value="${escapeHtml(opt.player)}" oninput="updateOption(${index}, ${optIndex}, 'player', this.value)">
                    </div>
                    <div>
                        <label>NPC Response (Command)</label>
                        <input type="text" value="${escapeHtml(opt.npc)}" oninput="updateOption(${index}, ${optIndex}, 'npc', this.value)">
                    </div>
                    <div>
                        <label>Goes To</label>
                        <select onchange="updateOption(${index}, ${optIndex}, 'target', this.value)">
                            ${generateTargetOptions(opt.target)}
                        </select>
                    </div>
                    <button class="btn-del" onclick="removeOption(${index}, ${optIndex})">X</button>
                `;
                optsContainer.appendChild(row);
            });
        });

        generateCode();
    }

    // --- Move Logic ---
    function moveOption(stateIdx, optIdx, direction) {
        const options = states[stateIdx].options;
        const newIndex = optIdx + direction;

        // Safety check bounds
        if (newIndex < 0 || newIndex >= options.length) return;

        // Swap elements
        const temp = options[optIdx];
        options[optIdx] = options[newIndex];
        options[newIndex] = temp;

        render();
    }

    // --- Standard Logic ---

    function generateTargetOptions(currentVal) {
        let html = `<option value="-1" ${currentVal == -1 ? 'selected' : ''}>Exit (-1)</option>`;
        states.forEach((s, i) => {
            html += `<option value="${i}" ${currentVal == i ? 'selected' : ''}>Page ${i}</option>`;
        });
        return html;
    }

    function addState() {
        states.push({ id: states.length, options: [] });
        render();
    }

    function removeState(index) {
        if(confirm("Delete this page? This will shift index numbers for pages below it.")) {
            states.splice(index, 1);
            render();
        }
    }

    function addOption(stateIndex) {
        states[stateIndex].options.push({ player: "", npc: "say ", target: -1 });
        render();
    }

    function removeOption(stateIndex, optIndex) {
        states[stateIndex].options.splice(optIndex, 1);
        render();
    }

    function updateOption(stateIndex, optIndex, field, value) {
        states[stateIndex].options[optIndex][field] = field === 'target' ? parseInt(value) : value;
        generateCode();
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/"/g, "&quot;");
    }

    function generateCode() {
        let code = `int set_up_talk()\n{\n    set_talk(({\n`;
        states.forEach((state, i) => {
            code += `        // Page ${i}\n        ({\n`;
            state.options.forEach(opt => {
                const safePlayer = opt.player ? opt.player.replace(/"/g, '\\"') : "";
                const safeNPC = opt.npc ? opt.npc.replace(/"/g, '\\"') : "";
                code += `            ({ "${safePlayer}",\n               "${safeNPC}", ${opt.target} }),\n`;
            });
            code += `        }),\n`;
        });
        code += `    }));\n}`;
        output.value = code;
    }

    function copyCode() {
        output.select();
        document.execCommand('copy');
        alert("Code copied to clipboard!");
    }

    render();
</script>

</body>
</html>